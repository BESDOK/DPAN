% DPAN

function [out, ps] = myPan6(sol, userdata)
pan = double(userdata.pan);
msi = double(userdata.msi);
n=size(sol,1);
out=inf(n,1);
ps=msi; %memory
for i=1:n
    k=sol(i,1:9);
    k=reshape(k,3,3);
    k=k./sum(k(:));    
    low=imfilter(pan,k,"replicate");
    hi=pan-low;

    w=sol(i,10:end);
    for j=1:3
        ps(:,:,j) = pan + w(j)*(msi(:,:,j)-pan) + w(j+3)*hi;
    end

    out(i)=( rmse(msi,ps) + rmse( cat(3,pan,pan,pan),ps) )/ 2;

end